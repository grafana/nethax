FROM --platform=$BUILDPLATFORM golang:1.25-alpine@sha256:b6ed3fd0452c0e9bcdef5597f29cc1418f61672e9d3a2f55bf02e7222c014abd AS build

WORKDIR /

# Copy source code
COPY [".", "."]

# Download dependencies
RUN ["go", "mod", "download"]

# Build the probe binary
ARG PROBE_IMAGE
#  Passed in from buildx
ARG TARGETOS
ARG TARGETARCH
# Build the probe binary
RUN env CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -ldflags="-w -s -extldflags '-static' -X 'github.com/grafana/nethax/pkg/kubernetes.DefaultProbeImage=${PROBE_IMAGE}'" -a -o /nethax ./cmd/nethax
RUN env CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s -extldflags '-static' -X 'github.com/grafana/nethax/pkg/kubernetes.DefaultProbeImage=${PROBE_IMAGE}'" -a -o /nethax ./cmd/nethax

FROM scratch

COPY --from=build /nethax /nethax

ENTRYPOINT ["/nethax"]
